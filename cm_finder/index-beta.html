<!DOCTYPE html>
<html>
<head>
    <title>CM Finder</title>
    <style>
      #marker-text {
        border-color: lightblue;
        border-width: medium;
        border-style: solid;
        color: navy;
        background-color: deepskyblue;
        padding-top: 15px;
        padding-bottom: 15px;
        margin-left: 25px;
        margin-right: 25px;
        border-radius: 20px;
        font-size: 5.75em;
      }
      .warning h2 {
        font-size: 3.5em;
      }
      .warning h3 {
        font-size: 3em;
      }
      #start-button button {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        -ms-transform: translateX(-50%);
        padding: 7px;
        background-color: deepskyblue;
        color: black;
      }
      #start-button select {
        font-size: 2.9em;
        padding: 7px;
        margin-top: 3.5em;
        margin-left: 25px;
        margin-right: 25px;
        background-color: deepskyblue;
        border-color: white;
        border-width: medium;
        color: black;
      }
      #cms-ver {
        text-align: left;
        font-size: 1.5em;
        margin-top: 10em;
        border-bottom: 2px solid skyblue;
        padding-bottom: 7px;
      }
    </style>
</head>
<body style="background-color: black; color: deepskyblue;">

<script>
  const urlParams = new URLSearchParams(window.location.search);
  let rallyeID = urlParams.get('rallye');
  const cacheBust = '?ver=20251109';
  const rallyeDict = {
    'wicked': {'script': 'wicked-cms.js', 'name': 'Wicked Rallye (Cris Testing!)', 'short_name': 'Wicked'},
    'route-66': {'script': 'route66-cms.js', 'name': 'Get Your Kicks on Route 66 (Nov 2018)', 'short_name': 'Route 66 (Nov 2018)'},
    'lick-observatory': {'script': 'lick-observatory-cms.js', 'name': 'The Search for Terrestrial Intelligence (Aug 2025)', 'short_name': 'Lick Observatory (Aug 2025)'}
  }
  const defaultRallye = 'wicked';

  function loadScript(src) {
    const script = document.createElement('script');
    script.src = src;
    script.type = 'text/javascript'; // Optional, but good practice
    script.async = true; // Scripts loaded this way are async by default, but explicit is clear

    document.body.appendChild(script); 
  }

  function setRallye() {
    // Load the appropriate javascript file based on the rallye ID
    if (rallyeID === null) {
      rallyeID = defaultRallye;
    }
    if (rallyeID in rallyeDict) {
      loadScript('rallyes/' + rallyeDict[rallyeID].script + cacheBust);
      document.getElementById('rallye-name').innerHTML = rallyeDict[rallyeID].name;
    } else {
      // If the rallye ID is invalid, show an error message
      alert('Invalid rallye ID: ' + rallyeID);
      document.getElementById('start-button').innerHTML = '<h1 style="text-align: center; font-size: 3.5em;">Invalid rallye ID: ' + rallyeID + '</h1>';
    }
  }

  function doReload() {
    const url = new URL(window.location.href);
    url.searchParams.set('rallye', document.getElementById('rallye-select').value);
    window.location.href = url.href;
  }

  // Populate the rallye select with the rallye IDs
  function populateRallyeSelect() {
    const rallyeSelect = document.getElementById('rallye-select');
    for (const rallyeID in rallyeDict) {
      const option = document.createElement('option');
      option.value = rallyeID;
      option.innerHTML = rallyeDict[rallyeID].short_name;
      rallyeSelect.appendChild(option); 
    }
  }

  window.onload = function() {
    setRallye();
    populateRallyeSelect();
  }
</script>
<script src="cm_finder_beta.js?ver=20251109"></script>

<div id="warn-stale" class="warning" style="display: none; background-color: firebrick; color: white; padding-left: 5px; padding-right: 5px;">
  <h2>Warning: Stale location data!</h2>
  <h3>Location data has not been updated in more than <span id="update-time">7</span> seconds. If the data does not update soon, consider reloading and ensure you allowed access to location data.</h3>
</div>

<div id="warn-accuracy" class="warning" style="display: none; background-color: goldenrod; color: black; padding-left: 5px; padding-right: 5px;">
  <h2>Warning: Degraded location accuracy!</h2>
  <h3>You may want to wait a few seconds for accuracy to improve and revisit the current section of the route.</h3>
</div>

<div id="start-button">
  <!-- <button type="button" onclick="test_rallye()" style="font-size: 3em;">Run a test rallye!</button> -->
  <h1 style="text-align: center; font-size: 3.5em;">GPS Coursemarker Tracking</h1>
  <h2 style="text-align: center; font-size: 2.3em; color: white;">Rallye: <span id="rallye-name"></span></h2>
  <h2 style="text-align: left; font-size: 2.3em;">When you're ready to leave the parking lot, click the button below to begin searching for CMs:</h2>
  <br />
  <br />
  <br />
  <button type="button" onclick="watchLocation()" style="font-size: 3.5em;">Start the Rallye</button>
  <div id="cms-ver">.</div>
  <br />
  <br />
  <button type="button" onclick="testSound()" style="font-size: 3.5em; margin-top: 0.2em;">Test Sound</button>
  <br />
  <select id="alert-select" onchange="updateAlert()">
    <option value="default" disabled selected>Want a different alert sound?</option>
    <option value="chime-audio">Ding-Dong</option>
    <option value="meep-audio">Meep Meep</option>
    <option value="bike-horn-audio">Vintage Bike Horn</option>
    <option value="ahooga-audio">Ahooga</option>
    <option value="frog-audio">Frog</option>
    <option value="owl-audio">Owl</option>
  </select>
  <br />
  <select id="rallye-select" style="margin-top: 2.0em" onchange="doReload()">
    <option value="default" disabled selected>Looking for a different rallye?</option>
  </select>
</div>

<div id="searching" style="display: none;">
  <h1 style="text-align: center; font-size: 3.5em;">Searching for Coursemarkers...</h1>
  <br />
  <!-- <img src="https://media1.tenor.com/m/8Juj0k-1L4AAAAAd/radar-love-search.gif" width="75%"> -->
  <!-- <img src="https://cdn.dribbble.com/users/568/screenshots/2937224/browserpreview_tmp.gif" width="100%"> -->
  <img src="radar_sweep.gif" width="100%">
  <div id="lastcm" style="font-size: 4.5em;">
    Last CM Seen:
  </div>
  <div id="search-pos" style="font-size: 2em;">
    Current Position
  </div>
</div>

<div id="demo" style="display: none;">
  Initializing...
</div>

<div id="log-button" style="display: none;">
  <br />
  <br />
  <br />
  <!-- <button type="button" onclick="show_log()" style="font-size: x-large;">Show tracking log</button>  -->
</div>

<div id="tracking-log" style="display: none;"></div>

<audio preload="auto" id="chime-audio">
  <source src="chime.mp3" type="audio/mpeg">
</audio>

<audio preload="auto" id="warn-audio">
  <source src="beeps3.mp3" type="audio/mpeg">
</audio>

<audio preload="auto" id="meep-audio">
  <source src="meepmeep.mp3" type="audio/mpeg">
</audio>

<audio preload="auto" id="bike-horn-audio">
  <source src="vintagebike.mp3" type="audio/mpeg">
</audio>

<audio preload="auto" id="ahooga-audio">
  <source src="ahooga.mp3" type="audio/mpeg">
</audio>

<audio preload="auto" id="frog-audio">
  <source src="frog.mp3" type="audio/mpeg">
</audio>

<audio preload="auto" id="owl-audio">
  <source src="owl.mp3" type="audio/mpeg">
</audio>

</body>
</html>